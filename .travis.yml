language: ruby
sudo: required
services:
  - docker
cache:
  bundler: true
  yarn: true
  directories:
  - node_modules
  - public/assets
  - public/packs-test
  - tmp/cache/babel-loader
dist: trusty
sudo: false
branches:
  only:
  - master
  - /^v\d+\.\d+(\.\d+)?(\S*)?(-\S*)?$/
notifications:
  email: false
env:
  global:
  - LOCAL_DOMAIN=cb6e6126.ngrok.io
  - LOCAL_HTTPS=true
  - RAILS_ENV=test
  - NOKOGIRI_USE_SYSTEM_LIBRARIES=true
  - PARALLEL_TEST_PROCESSORS=2
  - DOCKER_HUB_USERNAME=hello@heiber.im
  - secure: AUTarOhTGWI/XtER2HnVwevep5NL2NYJS8CvpwK60k027SLN218a1oSnXe0201AiLZCZpCvF+cUUulle1DAVxPDPj98cvZTqtbVs4oWtgKJo4QOSHVCQJZ0dTcWID2//jjYYDEXq93q0LWsrb41BjiW+HHv5LvLfNuRxAoTaLTYo46j0wHmLW448ePdoMG5YAniwXXEwpHGPC+dRdHc2ozlQCNkRblu7XA04BAgZhxTUV3n2nDzUvTP8hhqK52CbGZ+Aj92Gy2C8bBfiTpfSsfKgPtYsMaw9SoQhXAGW1mnaofPoeKvqxKAzyYvnVTHSPX0GrzVg5OXnsDN4N7HZwNesS+GNR1yyQuLEnhCBqe47NJSkoMC0arvUcsQijkef3MSI/RoGFvkvnqvzLk12C7XMoVwraj+ZE4akWifinJ5MQZ5kurIFUwS8PbZNGT6TFqLJpSv5n8FOqg5FVBgz7ymjWF3ndTuQOpw8mPB6bDH4c1sZCao4AGpCu5Z3GNnPXFbq2B9vILXphsV2x7ILO6/yoHR8QB0QBml+0lbxswit4hOYAY9J6o7CMBB1YE5W+TLkfeeKJuXdafAlWeiENkmUuPaLjjLSbr+m1OHzPfwx/ebrXpAHMESMCJSF6BMxjukAFerzrsxZFE3L6w5f+fj7pBabop35rctTlXa0XtM=
before_install:
  - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
  - sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
  - sudo apt-get update
  - sudo apt-get -y install docker-ce
addons:
  postgresql: 9.4
  apt:
    sources:
    - trusty-media
    - sourceline: deb https://dl.yarnpkg.com/debian/ stable main
      key_url: https://dl.yarnpkg.com/debian/pubkey.gpg
    packages:
    - ffmpeg
    - libicu-dev
    - libprotobuf-dev
    - protobuf-compiler
    - yarn
rvm:
- 2.4.2
- 2.5.0
services:
- redis-server
install:
- nvm install
- bundle install --path=vendor/bundle --without development production --retry=3 --jobs=16
- yarn install
before_script:
- "./bin/rails parallel:create parallel:load_schema parallel:prepare assets:precompile"
script:
- travis_retry bundle exec parallel_test spec/ --group-by filesize --type rspec
- yarn test
- bundle exec i18n-tasks check-normalized && bundle exec i18n-tasks unused
deploy:
  provider: script
  script: bash deploy_hub.sh
  on:
    tags: true
